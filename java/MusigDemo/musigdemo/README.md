# Overview

This is an example of using musig as an aar package. Some help for building a threshold signature wallet for Android.

# Dependencies

Step 1. Add the JitPack repository to your build file

```
allprojects {
		repositories {
			...
			maven { url 'https://jitpack.io' }
		}
	}
```

Step 2. Add the dependency
```
dependencies {
	        implementation 'com.github.hacpy:musig:1.2.5'
	}
```

Step 3. Import musig
```
import com.example.musig.Musig;
import com.example.musig.Mast;
```

# Api
### Musig
**getMusig(private)**
```java
Pass in the private key string to create the musig pointer for multi-signature.
```

**getMyPrivkey(phrase)**
```java
Pass in the phrase to get the private key.
Returns: <String>
Return a 32-byte private key key string.
Possible error string returned is `InvalidPhrase`.
```

**getMyPubkey(private)**
```java
Pass in the private key to get the public key.
Returns: <String>
Return a 32-byte public key string.
Possible error string returned is `Invalid Secret Bytes`.
```

**getMyReveal(musig)**
```java
Pass in the musig pointer.
Returns: <String>
Returns a 96-byte reveal string.
Possible error strings returned are `Null Musig` or `Invalid Reveal Bytes`.
```

**encodeRevealStage(musig)**
```java
Pass in the musig pointer.
Returns: <String>
Possible error strings returned are `Encode Fail`.
```

**decodeRevealStage(reveal_stage)**
```java
Pass in the reveal stage string.
Returns: musig pointer
Possible error strings returned are `Null Musig`.
```

**getMyCosign(musig, [reveals], [pubkeys])**
```java
Pass in the musig pointer, the reveals and public-keys of other signers.
Returns: <String>
Returns a 32-byte cosign string.
Possible error strings returned are `Null Musig` or `Invalid Cosign Bytes`.
```

**getAggSignature([reveals], [pubkeys], [cosigns])**
```java
Pass in the reveals, public-keys and cosigns of other signers.
Returns: <String>
Returns a 64-byte signature string.
Possible error string returned is `Invalid Signature`.
```

**getAggPublicKey([pubkeys])**
```java
Pass in the public-keys to be aggregated.
Returns: <String>
Returns a 32-byte aggregate public-key string.
Possible error strings returned are `Null Musig` or `Invalid Commit Bytes`.
```

### Mast

**generateThresholdPubkey(pubkeys, threshold)**
```java
Generate threshold signature addresses by passing in 
all signer public keys and signature thresholds.
Returns: <String>
Return the public key of the threshold-signature address.
Possible error string returned is `Invalid Public Bytes`.
```
**generateControlBlock(pubkeys, threshold, aggPubkey)**
```java
Generate a proof of the aggregated public key by 
passing in the public key and signature threshold of 
all signers and the aggregated public key of everyone 
who performed the signature this time.
Returns: <String>
Return signed proofs for transaction validation.
Possible error string returned is `Invalid Public Bytes`.
```

# Example

The specific usage can be viewed in [MainActivity.java](src/main/java/com/example/musigdemo/MainActivity.java).This example simulates three people generating aggregated public keys and aggregated signatures.

## Details

### Musig

- Pass in the phrase to generate private key

~~~java
String privateA = Musig.getMyPrivkey(phrase1);
~~~


- Pass in the private key to declare a musig pointer and get my pubkey

~~~java
Pointer musig0 = Musig.getMusig(private1);
String pubkey0 = Musig.getMyPubkey(private1);
~~~

- Use musig pointer to  reveal.

~~~java
String reveal0 = Musig.getMyReveal(musig0);
~~~

- Reveal stage object serialization

~~~java
String musig0_reveal_stage = encodeRevealStage(musig0);
~~~

- Reveal stage object deserialization

~~~java
Pointer musig0 = Musig.decodeRevealStage(musig0_reveal_stage);
~~~

- Pass the self-generated pubkey and reveal to the other two parties, and the other two parties do the same. In the end, I got the public key and reveal of the other two parties. Pass in the `getMyCosign` function to generate my own cosign. **Note that when passing parameters here, pubkey and reveal must correspond one to one**.

~~~java
String cosign0 = Musig.getMyCosign(musig0, new String[]{reveal1, reveal2},
        new String[]{pubkey1, pubkey2});
~~~

- Like commit, pass the cosign and pubkey generated by myself to the other two parties, and I can finally generate the signature by `getAggSignature`. **Note that when passing parameters here, reveal, pubkey and reveal must correspond one to one**.

~~~java
String signature = Musig.getAggSignature(new String[]{reveal0, reveal1, reveal2},
                new String[]{cosign0, cosign1, cosign2},
                new String[]{pubkey0, pubkey1, pubkey2});
~~~

- When I obtain the public keys of the other two parties, I can generate the aggregate public key. **Note that the public key here must be in order, and the incoming order of the `getAggSignature` must be consistent.**

~~~java
String pubkey = Musig.getAggPublicKey(new String[]{pubkey0, pubkey1, pubkey2});
~~~

### Mast

- The threshold signature address can be generated by using the threshold and the public key of the all participant.

~~~java
String thresholdPubkey = Mast.generateThresholdPubkey(new String[]{publicA, publicB, publicC}, (byte) 2);
~~~

- Using the threshold, the public keys of all participants and the aggregation of the public keys can generate a proof.

~~~java
String control = Mast.generateControlBlock(new String[]{publicA, publicB, publicC}, (byte) 2, publicAB);
~~~
